# 用語集作成システム - 設計概要

## プロジェクト目標

Baldur's Gate Enhanced Edition (BG1EE/BG2EE) の公式英日翻訳TRAファイルから、翻訳Mod制作に活用できる包括的な用語集を自動生成する。

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        入力データ                              │
│  source_tra/                                                 │
│  ├── bg1ee/                                                  │
│  │   ├── en_US/dialog.tra  (34,000エントリ)                  │
│  │   └── ja_JP/dialog.tra  (34,000エントリ + 性別バリアント)   │
│  └── bg2ee/                                                  │
│      ├── en_US/dialog.tra  (128,424エントリ)                 │
│      └── ja_JP/dialog.tra  (128,424エントリ + 性別バリアント)  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      処理パイプライン                          │
│                                                              │
│  1. TRAパーサー (tra_parser.py)                              │
│     ├─ ファイル読み込み                                       │
│     ├─ 正規表現によるエントリ抽出                              │
│     ├─ 性別バリアント分離                                     │
│     └─ ID → Entry マッピング生成                             │
│                                                              │
│  2. 用語集ビルダー (glossary_builder.py)                      │
│     ├─ 英日エントリマッピング (@ID基準)                        │
│     ├─ 不要エントリのフィルタリング                            │
│     ├─ メタデータ生成                                        │
│     └─ GlossaryEntry オブジェクト構築                         │
│                                                              │
│  3. 用語抽出器 (term_extractor.py)                           │
│     ├─ 固有名詞抽出 (大文字始まり単語)                         │
│     ├─ 頻出フレーズ検出                                       │
│     ├─ 用語頻度インデックス構築                                │
│     └─ 翻訳一貫性チェック                                     │
│                                                              │
│  4. JSON出力                                                 │
│     ├─ メタデータセクション生成                                │
│     ├─ エントリ配列出力                                       │
│     └─ 用語頻度インデックス追加                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        出力データ                              │
│  glossary.json                                               │
│  ├── metadata: 統計情報、生成日時                             │
│  ├── entries: 全翻訳ペア (162,424エントリ)                    │
│  └── term_frequency: 固有名詞・頻出語インデックス              │
└─────────────────────────────────────────────────────────────┘
```

## データフロー詳細

### 入力: TRAファイルフォーマット

```
@1 = ~Why hast thou disturbed me here?~
```

### 中間: パースされたエントリ

```python
TRAEntry(
    tra_id=1,
    text="Why hast thou disturbed me here?"
)
```

### 出力: 用語集JSONエントリ

```json
{
  "id": "bg1ee:1",
  "english": "Why hast thou disturbed me here?",
  "japanese": {
    "default": "何故に私の邪魔をしに来たのだ？",
    "male": null,
    "female": null
  },
  "metadata": {
    "game": "bg1ee",
    "tra_id": 1,
    "has_variables": false,
    "has_sound_ref": false,
    "char_count_en": 32,
    "char_count_ja": 18
  }
}
```

## 主要コンポーネント

### 1. TRAパーサー

**入力**: TRAファイルパス
**出力**: `Dict[int, TRAEntry]`

**処理**:
1. UTF-8でファイル読み込み
2. 行ごとに正規表現マッチング
3. `@ID = ~text~` パターン抽出
4. 日本語の場合、性別バリアント分離
5. ID→Entryマッピング辞書構築

**エッジケース**:
- 複数の`~`を含む行（性別バリアント）
- `<NO TEXT>`, `placeholder`等の特殊値
- 変数タグ `<CHARNAME>`、サウンド参照 `[ZOMBI01]`

### 2. 用語集ビルダー

**入力**:
- 英語TRAエントリ辞書
- 日本語TRAエントリ辞書
- ゲーム名 (bg1ee/bg2ee)

**出力**: `List[GlossaryEntry]`

**処理**:
1. 同一IDの英日エントリをペアリング
2. スキップ条件チェック
3. メタデータ生成
   - 変数タグ検出
   - サウンド参照検出
   - 文字数カウント
4. GlossaryEntryオブジェクト構築

**フィルタリングルール**:
- `<NO TEXT>` を含むエントリ
- `placeholder` エントリ
- 英語が空文字列
- 日本語がすべてNull

### 3. 用語抽出器

**入力**: `List[GlossaryEntry]`
**出力**: `Dict[str, TermInfo]` (用語頻度インデックス)

**処理**:
1. **固有名詞抽出**
   - 英語で大文字始まりの単語を検出
   - 2回以上出現するもののみ
   - 対応する日本語訳を収集

2. **頻出フレーズ抽出**
   - 完全一致で5回以上出現
   - 短文（5単語以下）を優先

3. **翻訳一貫性チェック**
   - 同一英語に複数の日本語訳がある場合を検出
   - 警告レベルで出力

**除外パターン**:
- 変数タグ: `<CHARNAME>`, `<SIRMAAM>` 等
- ストップワード: the, a, is, are 等

## 実装優先順位

### Phase 1: MVP (Minimum Viable Product) - 最優先
✅ **目標**: 基本的な用語集JSONを出力

1. TRAパーサー基本実装
2. 単純な英日マッピング
3. JSON出力（メタデータなし）
4. 性別バリアント処理

**成果物**: 基本的なglossary.jsonファイル

### Phase 2: メタデータ・フィルタリング
✅ **目標**: 実用的な用語集の完成

1. メタデータ生成機能
2. スキップ条件実装
3. 統計情報生成
4. CLIインターフェース

**成果物**: 完全なglossary.jsonファイル

### Phase 3: 用語抽出（オプション）
⚠️ **目標**: 高度な用語分析

1. 固有名詞抽出
2. 頻度インデックス構築
3. 翻訳一貫性チェック

**成果物**: term_frequencyセクション付き用語集

### Phase 4: 最適化・拡張
⚠️ **目標**: パフォーマンス向上と機能拡張

1. 大量データ処理の最適化
2. ストリーミング処理
3. 差分更新機能
4. 複数出力フォーマット (CSV, SQLite)

## 技術的課題と解決策

### 課題1: 大量エントリの処理速度

**問題**: BG2EEは128,424エントリと大量

**解決策**:
- ジェネレータ式によるストリーミング処理
- 必要に応じてチャンク分割
- プログレスバー表示（tqdm）

### 課題2: 性別バリアントの正確な分離

**問題**: `~ ~` 区切りが複数パターン存在の可能性

**解決策**:
- 厳密な正規表現パターン
- テストケースによる検証
- エラーログ出力

### 課題3: メモリ使用量

**問題**: 全エントリをメモリ展開すると100-200MB

**解決策**:
- 必要最小限のデータ構造
- 不要エントリの早期フィルタリング
- オンデマンド読み込み（Phase 4）

### 課題4: 翻訳一貫性の判定

**問題**: 同一英語に複数訳が正当な場合もある（文脈依存）

**解決策**:
- 単純な重複検出のみ実装
- 判断は人間に委ねる
- 警告レベルで出力

## 期待される成果物の活用方法

### 1. 翻訳Mod制作支援

- 固有名詞の統一表記確認
- 定型句の再利用
- 翻訳スタイルの参考

### 2. 機械翻訳の辞書データ

- Claude API等への用語集提供
- コンテキスト付き翻訳支援

### 3. 品質チェック

- 同一英語への複数訳検出
- 訳抜け・誤訳候補の発見

### 4. 翻訳メモリ

- 類似文の検索
- 既存翻訳の流用

## パフォーマンス目標

- **処理時間**: 全エントリ処理で1分以内
- **メモリ使用量**: 200MB以内
- **出力ファイルサイズ**: 50-100MB (JSON)

## 今後の拡張可能性

1. **Web UI**: ブラウザベースの検索・閲覧
2. **Claude API統合**: 文脈分析、カテゴリ分類
3. **差分更新**: 既存用語集との差分抽出
4. **複数ゲーム対応**: IWD:EE, PST:EE等への拡張
5. **SQLiteバックエンド**: 高速検索・インデックス
